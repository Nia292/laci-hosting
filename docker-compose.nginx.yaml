services:
  postgres:
    image: postgres:latest
    command: ["postgres", "-c", "log_statement=all"]
    restart: always
    environment:
      POSTGRES_DB: "${LACI_POSTGRES_DB}"
      POSTGRES_USER: "${LACI_POSTGRES_USER}"
      POSTGRES_PASSWORD: "${LACI_POSTGRES_PASSWORD}"
    volumes:
      - postgresql:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${LACI_POSTGRES_USER} -d ${LACI_POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
  web:
    image: docker.io/jonasal/nginx-certbot
    restart:
      always
    volumes:
      - ./configs/conf.d:/etc/nginx/user_conf.d:ro
      - letsencrypt:/etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"
    environment:
      CERTBOT_EMAIL: "${CERTBOT_EMAIL}"
  redis:
    image: redis:latest
    command: [sh, -c, "rm -f /data/dump.rdb && redis-server --save \"\" --appendonly no --requirepass ${LACI_REDIS_PASSWORD}"]
    volumes:
      - rediscache:/data

  server:
    image: ghcr.io/lacisynchroni/server:1.1.0
    restart: on-failure
    environment:
      SinusSynchronous__ShardName: "${LACI_SHARD_NAME}"
      SinusSynchronous__ServerName: "${LACI_SERVER_NAME}"
      SinusSynchronous__ServerPublicUri: "${LACI_PUBLIC_URI}"
      SinusSynchronous__CdnFullUrl: "${LACI_CDN_URL}"
      SinusSynchronous__Jwt: "${LACI_JWT_SIGNING_KEY}"
      SinusSynchronous__JwtKeyId: "${LACI_JWT_KEY_ID}"
      SinusSynchronous__RedisConnectionString: "redis,password=${LACI_REDIS_PASSWORD}"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=${LACI_POSTGRES_DB};Username=${LACI_POSTGRES_USER};Password=${LACI_POSTGRES_PASSWORD};Keepalive=15;Minimum Pool Size=10;Maximum Pool Size=50;No Reset On Close=true;Max Auto Prepare=50;Enlist=false"
      DOTNET_USE_POLLING_FILE_WATCHER: 1
      APPSETTINGS_PATH: "/opt/LaciSynchroni/Server/appsettings.json"
    volumes:
      - ./configs/server.json:/opt/LaciSynchroni/Server/appsettings.json
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:6000/health || exit 1"]
      retries: 60
      start_period: 10s
      timeout: 1s

  services:
    image: ghcr.io/lacisynchroni/services:1.1.0
    restart: on-failure
    environment:
      SinusSynchronous__DiscordBotToken: "${LACI_DISCORD_TOKEN}"
      SinusSynchronous__Jwt: "${LACI_JWT_SIGNING_KEY}"
      SinusSynchronous__JwtKeyId: "${LACI_JWT_KEY_ID}"
      SinusSynchronous__RedisConnectionString: "redis,password=${LACI_REDIS_PASSWORD}"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=${LACI_POSTGRES_DB};Username=${LACI_POSTGRES_USER};Password=${LACI_POSTGRES_PASSWORD};Keepalive=15;Minimum Pool Size=10;Maximum Pool Size=50;No Reset On Close=true;Max Auto Prepare=50;Enlist=false"
      DOTNET_USE_POLLING_FILE_WATCHER: 1
      APPSETTINGS_PATH: "/opt/LaciSynchroni/Services/appsettings.json"
    volumes:
      - ./configs/services.json:/opt/LaciSynchroni/Services/appsettings.json
    depends_on:
      server:
        condition: service_healthy
      postgres:
        condition: service_healthy

  auth:
    image: ghcr.io/lacisynchroni/authservice:1.1.0
    restart: on-failure
    environment:
      SinusSynchronous__PublicOAuthBaseUri: "${LACI_PUBLIC_OAUTH_BASE_URI}"
      SinusSynchronous__DiscordOAuthClientSecret: "${LACI_DISCORD_OAUTH_CLIENT_SECRET}"
      SinusSynchronous__DiscordOAuthClientId: "${LACI_DISCORD_OAUTH_CLIENT_ID}"
      SinusSynchronous__Jwt: "${LACI_JWT_SIGNING_KEY}"
      SinusSynchronous__JwtKeyId: "${LACI_JWT_KEY_ID}"
      SinusSynchronous__RedisConnectionString: "redis,password=${LACI_REDIS_PASSWORD}"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=${LACI_POSTGRES_DB};Username=${LACI_POSTGRES_USER};Password=${LACI_POSTGRES_PASSWORD};Keepalive=15;Minimum Pool Size=10;Maximum Pool Size=50;No Reset On Close=true;Max Auto Prepare=50;Enlist=false"
      DOTNET_USE_POLLING_FILE_WATCHER: 1
      APPSETTINGS_PATH: "/opt/LaciSynchroni/AuthService/appsettings.json"
    volumes:
      - ./configs/authservice.json:/opt/LaciSynchroni/AuthService/appsettings.json
    depends_on:
      server:
        condition: service_healthy
      postgres:
        condition: service_healthy

  files:
    image: ghcr.io/lacisynchroni/staticfilesserver:1.1.0
    restart: on-failure
    # This enables full access on the mod_file_cache
    user: "root:root"
    environment:
      SinusSynchronous__CdnFullUrl: "${LACI_CDN_URI}"
      SinusSynchronous__Jwt: "${LACI_JWT_SIGNING_KEY}"
      SinusSynchronous__JwtKeyId: "${LACI_JWT_KEY_ID}"
      SinusSynchronous__RedisConnectionString: "redis,password=${LACI_REDIS_PASSWORD}"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=${LACI_POSTGRES_DB};Username=${LACI_POSTGRES_USER};Password=${LACI_POSTGRES_PASSWORD};Keepalive=15;Minimum Pool Size=10;Maximum Pool Size=50;No Reset On Close=true;Max Auto Prepare=50;Enlist=false"
      DOTNET_USE_POLLING_FILE_WATCHER: 1
      APPSETTINGS_PATH: "/opt/LaciSynchroni/StaticFilesServer/appsettings.json"
    volumes:
      - ./configs/files.json:/opt/LaciSynchroni/StaticFilesServer/appsettings.json
      - mod_file_cache:/laci-cache/:rw
    depends_on:
      postgres:
        condition: service_healthy
      server:
        condition: service_healthy

volumes:
  rediscache:
    driver: local
  postgresql:
  mod_file_cache:
  letsencrypt: